---
title: 접속 IP 로그 기록을 위한 배치 파일 만들기 (netstat)
category: Etc.
tag: ["netstat", "Batch file"]
---

이번 포스트에서는 **내 PC에 접근한 ip를 기록하는 로그 파일 생성 방법**을 소개할께.

누가 언제 내 PC로 접근했는지 기록하는 것은 보안 관리를 위한 목적, 또는 내가 제공하는 서비스의 사용자 정보를 확인하는 목적에서 사용될 수 있어.

나는 후자의 목적으로 내가 만든 서비스에 접근한 사용자 ip를 120초 주기로 확인해서 기록하는 로그 파일을 생성했어.

로그 파일은 다음과 같이 구성된 **배치(batch) 파일**을 만들어서 실행하면 얻을 수 있었어.

 - **배치(batch) 파일의 구성**
 
   1. **netstat 명령어**를 이용해서 현재 접속한 ip 확인
   2. netstat의 결과를 "**>>**" 명령어로 **로그를 저장할 파일에 출력**
   3. **timeout / goto 명령어**를 이용해 120초 간격으로 1 & 2를 실행
  
그럼 위에서 말한 배치 파일과 그 안에 들어가는 netstat, timeout, goto 명령어를 알아보고, 실제 만들어진 배치 파일을 살펴보자.

---

## 배치(batch) 파일 구성

**배치 파일**은 **명령 프롬프트(cmd)에서 실행하는 명령어를 묶어서 실행할 수 있도록 만든 파일**이야. 

Notepad 에 명령어를 구성하고 **.bat** 확장자로 저장하면 배치 파일이 생성되고, 생성된 배치 파일을 실행하면 그 안에 있는 명령어가 자동으로 실행이 돼.

### netstat (cmd 명령어)

**netstat**(network statistics)는 내 PC에 연결된 네트워크 상태를 확인할 수 있는 cmd 명령어야. 

어떤 포트가 열려있고, 현재 포트에 연결되어 있는 상대방 정보 등을 알 수 있어. 

netstat 명령어 뒤에는 여러 옵션을 사용할 수 있지만, 오늘은 자주 사용하는 2개의 옵션만 설명하도록 할께.

 - -a : 모든 연결 및 수신대기 포트를 표시하는 옵션
 - -n : 주소나 포트형식을 숫자로 표시하는 옵션

```powershell
C:/Users/82107> netstat -an
```

위의 명령어를 cmd에서 실행하게 되면 모든 네트워크(수신 대기 + 연결) 정보를 결과로 보여줘. 

<a href="https://i.imgur.com/yIeGHgj"><img src="https://i.imgur.com/yIeGHgj.png" width="800px" title="source: imgur.com" /></a>

결과는 4개 항목으로 구성되어 있어.

  - 프로토콜 : 사용 프로토콜
  - 로컬주소 : 열려있는 내 PC의 ip/포트번호
  - 외부주소 : 내 PC와 연결된 상대방 ip/포트번호
  - 상태 : 연결상태
    + LISTENING : 현재 서비스를 대기 중
    + ESTABLISHED : 연결된 상태
    + TIME_WAIT : 연결이 종료되었으나 당분간 포트는 열어놓은 상태
    + CLOSED : 완전히 연결이 종료된 상태

netstat 명령어를 사용하면 모든 네트워크 정보가 나타나는데, 이 중 내가 제공하는 서비스의 접속 포트 정보만 확인하기 위해서는 **find** 명령어를 사용하면 돼.

**find "문자열"** 명령어는 해당 문자열을 포함한 결과만 보여주는 명령어야.

예를들어 내 서비스의 포트가 5601 일 때, 해당 포트로의 접속 정보만 확인하는 방법은 다음과 같아.

```powershell
C:/Users/82107> netstat -an | find "5601"
```

### timeout (cmd 명령어)

**timeout**은 시간지연을 위한 명령어야. **timeout 지연시간** 형태로 사용하며 해당 시간만큼 다음 명령어의 실행을 지연시켜.

예를들어 30초간 지연시간을 가지려면 다음을 실행하면 돼.

```powershell
C:/Users/82107> timeout 30
```

### goto (cmd 명령어)

**goto**는 구문내의 특정 위치로 이동하는 명령어야.

**goto 레이블** 형태로 사용되며 구문 내에 미리 정의한 **레이블** 위치로 이동하게 돼.

반복실행을 할 때 사용하며, 다음과 같이 사용할 수 있어.

```powershell
:1
  구문 1
  구문 2
  ~~
goto 1
```

레이블은 **: 레이블명**으로 설정할 수 있으며, 위의 코드는 :1 에서 goto 1을 반복실행하는 코드야.

---

## 예제 : 로그 기록을 위한 배치 파일 

위에서 설명한 명령어를 이용해서 다음의 log.bat 배치 파일을 만들었어.

해당 파일은 **120초 간격으로 내 서비스 포트 5601에 접속한 ip 정보를 수집하는 배치파일**이야.

```powershell
:: log.bat 파일
@echo off
  :1
    echo --- %time% --- >> C:/user_log/log_%date%.txt
    
    netstat -an | find "5601" >> C:/user_log/log_%date%.txt
    
    timeout 120 /nobreak > NUL
    
    goto 1
```

파일의 구문 설명은 다음과 같아.

 0. **::** 은 배치파일 내에서 주석을 의미해.

 1. 두번째 줄에 **@echo off** 는 배치파일 실행시에 명령어가 나오지 않게 하는 설정이야.
   + 배치파일 실행시에 cmd 창에 내가 작성한 명령어가 나오지 않게 돼.
 
 2. 주기적으로 구문 반복을 위해 **goto** 명령어 사용했어.
   + **:1**에서 **goto 1** 까지 구문이 반복실행 돼.

 3. 네번째 줄에 **echo** 는 따라오는 문자열을 출력하는 명령어야. 로그가 수집될 때의 시간을 출력하기 위해 사용했어.
   + **%time%** 는 현재 시간을 출력하는 명령어야.
   + 해당 줄이 실행되면 **--- 13:24:01.3 ---** 등의 결과가 출력돼.
 4. 네번째 줄에 **>>** 는 명령어 실행 결과를 오른쪽에 명시된 파일에 출력하는 명령어야.
   + **>** 는 덮어쓰기, **>>** 는 이어쓰기 명령어야.
   + "C:/user_log/log_%date%.txt" 파일에 현재 시간이 출력돼.
   + **%date%** 는 오늘 날짜를 출력하는 명령어야.

 5. 여섯번째 줄에 **netstat** 과 **find** 명령어로 5601 포트에 연결된 ip 정보를 확인하고, "C:/user_log/log_%date%.txt"에 출력하게 돼.
 
 6. 여덟번째 줄에 **timeout** 명령어로 120초 간격으로 로그 수집이 되도록 했어.
   + 시간이 지연되는 중간에 cmd 창에서 어떤 키를 누르면 지연이 끝나게 돼.
   + 어떤 키를 눌러도 120초 간격이 유지되도록 **/nobreak** 명령어를 써주었어.
   + timeout 명령어가 실행되면 cmd 창에 "x 초 기다리는 중" 이라는 문자열이 나오게 돼. cmd 창에 아무것도 출력되지 않도록 **> NUL** 을 추가했어.

만들어진 log.bat 파일을 실행하면 "C:/user_log/log_%date%.txt" 파일이 생성되고 다음의 내용처럼 로그가 저장되지.

<a href="https://i.imgur.com/yIeGHgj"><img src="https://i.imgur.com/yIeGHgj.png" width="800px" title="source: imgur.com" /></a>

